# This is a basic workflow to help you get started with Actions

name: Maven Repo CLone

# Controls when the action will run.
on:
  schedule:
    - cron: "0 7,19 * * *" # This is in UTC time which makes the actual run 1AM and 1PM CST
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  ARTIFACT_DIR: "./maven-repo"
  
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  download-maplesim:
    name: Download MapleSim
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Project
      uses: actions/checkout@v4
    - name: Checkout Maplesim Repo
      uses: actions/checkout@v4
      with:
        repository: Shenzhen-Robotics-Alliance/maple-sim
        ref: gh-pages
        path: maven-temp
    - name: Copy Maven files
      run: |-
        mkdir $ARTIFACT_DIR
        cp -R maven-temp/vendordep/repos/releases/* $ARTIFACT_DIR/
    # This grabs the WPILib docker container
    - uses: actions/upload-artifact@v4
      with:
        name: maplesim
        path: ${{ env.ARTIFACT_DIR }}
  download-pathplanner:
    name: Download PathPlanner
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Project
      uses: actions/checkout@v4
    - name: Checkout PathPlanner Repo
      uses: actions/checkout@v4
      with:
        repository: 3015RangerRobotics/3015RangerRobotics.github.io
        ref: main
        path: maven-temp
    - name: Copy Maven files
      run: |-
        mkdir $ARTIFACT_DIR
        cp -R maven-temp/pathplannerlib/repo/* $ARTIFACT_DIR/
    # This grabs the WPILib docker container
    - uses: actions/upload-artifact@v4
      with:
        name: pathplanner
        path: ${{ env.ARTIFACT_DIR }}
  download-choreo:
    name: Download Choreo
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Project
      uses: actions/checkout@v4
    - name: Checkout Choreo Repo
      uses: actions/checkout@v4
      with:
        repository: SleipnirGroup/ChoreoLib
        ref: main
        path: maven-temp
    - name: Copy Maven files
      run: |-
        mkdir $ARTIFACT_DIR
        cp -R maven-temp/dep/* $ARTIFACT_DIR/
    # This grabs the WPILib docker container
    - uses: actions/upload-artifact@v4
      with:
        name: choreo
        path: ${{ env.ARTIFACT_DIR }}
  download-direct-maven:
    name: Download files directly from Maven Servers
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Project
      uses: actions/checkout@v4
    - name: Restore cached libraries
      id: cache-maven-restore
      uses: actions/cache/restore@v4
      with:
        path: |
          ${{ env.ARTIFACT_DIR }}
        key: maven-libraries
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13' 
    - name: Install Python Requirements
      run: pip install -r requirements.txt
    - name: Copy Maven files
      run: |-
        python clone-maveny.py ${{ env.ARTIFACT_DIR }} --cache
    - name: Cache libraries
      id: cache-maven-save
      uses: actions/cache/save@v4
      with:
        path: |
          ${{ env.ARTIFACT_DIR }}
        key: ${{ steps.cache-maven-restore.outputs.cache-primary-key }}
    # This grabs the WPILib docker container
    - uses: actions/upload-artifact@v4
      with:
        name: other-maven
        path: ${{ env.ARTIFACT_DIR }}
  publish-pages:
    name: Upload to Github Pages
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    needs:
      - download-maplesim
      - download-pathplanner
      - download-choreo
      - download-direct-maven
    if: success() && github.ref_name == github.event.repository.default_branch
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      contents: read
      pages: write
      id-token: write
    concurrency:
      group: "pages"
      cancel-in-progress: true
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    - uses: actions/download-artifact@v4
      with:
        name: maplesim
        path: ${{ env.ARTIFACT_DIR }}
    - uses: actions/download-artifact@v4
      with:
        name: pathplanner
        path: ${{ env.ARTIFACT_DIR }}
    - uses: actions/download-artifact@v4
      with:
        name: choreo
        path: ${{ env.ARTIFACT_DIR }}
    - uses: actions/download-artifact@v4
      with:
        name: other-maven
        path: ${{ env.ARTIFACT_DIR }}
    - name: Setup Pages
      uses: actions/configure-pages@v5
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ${{ env.ARTIFACT_DIR }}
    - name: Deploy to Github Pages
      id: deployment
      uses: actions/deploy-pages@v4